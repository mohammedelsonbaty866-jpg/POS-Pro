<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…Ø­Ø§Ø³Ø¨ÙŠ Ø´Ø§Ù…Ù„</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">

<style>
body{font-family:Tahoma;background:#f4f6f8;margin:0}
header{background:#0d6efd;color:#fff;padding:15px;text-align:center;font-size:20px}
nav{display:flex;flex-wrap:wrap;background:#fff;border-bottom:1px solid #ddd}
nav button{flex:1;padding:10px;border:none;background:none;font-size:14px}
nav button.active{background:#0d6efd;color:#fff}
.container{padding:15px}
.box{background:#fff;padding:15px;margin-bottom:10px;border-radius:5px}
input,select,button{width:100%;padding:10px;margin-top:5px}
button.primary{background:#0d6efd;color:#fff;border:none}
hr{margin:15px 0}

/* Splash */
#splash{
position:fixed;top:0;left:0;width:100%;height:100%;
background:#0d6efd;display:flex;align-items:center;
justify-content:center;z-index:9999
}
#splash img{width:120px;height:120px}
</style>
</head>

<body>

<div id="splash">
  <img src="icon-512.png">
</div>

<header>ğŸ“Š Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…Ø­Ø§Ø³Ø¨ÙŠ Ø´Ø§Ù…Ù„</header>

<nav>
<button class="active" onclick="showSection('dashboard',this)">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
<button onclick="showSection('products',this)">Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
<button onclick="showSection('sales',this)">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>
<button onclick="showSection('purchases',this)">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button>
<button onclick="showSection('expenses',this)">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
<button onclick="showSection('reports',this)">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
<button onclick="showSection('settings',this)">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
</nav>

<div class="container">

<div id="dashboard" class="box">
<h3>Ù…Ø±Ø­Ø¨Ù‹Ø§ ğŸ‘‹</h3>
<p>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…Ø­Ø§Ø³Ø¨ÙŠ ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª (PWA)</p>
</div>

<div id="products" class="box" style="display:none">
<h3>ğŸ“¦ Ø§Ù„Ø£ØµÙ†Ø§Ù</h3>
<input id="productName" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
<input id="productPrice" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
<input id="productQty" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
<button class="primary" onclick="addProduct()">â• Ø¥Ø¶Ø§ÙØ©</button>
<div id="productList"></div>
</div>

<div id="sales" class="box" style="display:none">
<h3>ğŸ§¾ ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹</h3>
<select id="saleProduct"></select>
<input type="number" id="saleQty" value="1">
<button class="primary" onclick="addToInvoice()">â• Ø¥Ø¶Ø§ÙØ©</button>
<hr>
<div id="invoiceItems"></div>
<p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b id="subTotal">0</b></p>
<p id="taxRow" style="display:none">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: <b id="taxAmount">0</b></p>
<p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: <b id="grandTotal">0</b></p>
<button onclick="printInvoice()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
<button class="primary" onclick="saveInvoice()">ğŸ’¾ Ø­ÙØ¸</button>
</div>

<div id="purchases" class="box" style="display:none">
<h3>ğŸ§¾ ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡</h3>
<select id="purchaseProduct"></select>
<input id="newProductName" placeholder="Ø§Ø³Ù… ØµÙ†Ù Ø¬Ø¯ÙŠØ¯">
<input id="purchasePrice" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
<input id="purchaseQty" type="number" value="1">
<button class="primary" onclick="addPurchase()">â• Ø¥Ø¶Ø§ÙØ©</button>
<hr>
<div id="purchaseItems"></div>
<p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b id="purchaseTotal">0</b></p>
<button class="primary" onclick="savePurchase()">ğŸ’¾ Ø­ÙØ¸</button>
</div>

<div id="expenses" class="box" style="display:none">
<h3>ğŸ’¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
<select id="expenseType">
<option>Ø¥ÙŠØ¬Ø§Ø±</option>
<option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
<option>Ù…ÙŠØ§Ù‡</option>
<option>Ø±ÙˆØ§ØªØ¨</option>
<option>Ø£Ø®Ø±Ù‰</option>
</select>
<input id="expenseDesc" placeholder="Ø§Ù„ÙˆØµÙ">
<input id="expenseAmount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
<button class="primary" onclick="addExpense()">â• Ø¥Ø¶Ø§ÙØ©</button>
<div id="expenseList"></div>
</div>

<div id="reports" class="box" style="display:none">
<h3>ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h3>
<input type="date" id="fromDate">
<input type="date" id="toDate">
<button onclick="showSalesReport()">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>
<button onclick="showProfitReport()">Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø¦Ø±</button>
<button onclick="showStockReport()">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
<hr>
<button onclick="exportSalesExcel()">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
<button onclick="exportSalesPDF()">ğŸ“„ ØªØµØ¯ÙŠØ± PDF</button>
<div id="reportResult"></div>
</div>

<div id="settings" class="box" style="display:none">
<h3>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
<select id="taxEnabled">
<option value="false">Ø¨Ø¯ÙˆÙ† Ø¶Ø±ÙŠØ¨Ø©</option>
<option value="true">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</option>
</select>
<input id="taxRate" type="number" placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© %">
<button class="primary" onclick="saveSettings()">ğŸ’¾ Ø­ÙØ¸</button>
<hr>
<button onclick="backupData()">ğŸ“¦ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
<input type="file" onchange="restoreData(event)">
</div>

</div>

<script>
setTimeout(()=>splash.style.display="none",1500);

function showSection(id,b){
document.querySelectorAll('.box').forEach(x=>x.style.display='none');
document.getElementById(id).style.display='block';
document.querySelectorAll('nav button').forEach(x=>x.classList.remove('active'));
b.classList.add('active');
}

/* ====== DATA ====== */
let products = JSON.parse(localStorage.getItem('products')||'[]');
let sales = JSON.parse(localStorage.getItem('sales')||'[]');
let expenses = JSON.parse(localStorage.getItem('expenses')||'[]');
let settings = JSON.parse(localStorage.getItem('settings')||'{}');
let invoice=[];

/* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© */
settings={
taxEnabled:settings.taxEnabled ?? false,
taxRate:settings.taxRate ?? 0
};
taxEnabled.value=settings.taxEnabled.toString();
taxRate.value=settings.taxRate;

/* Ø§Ù„Ø£ØµÙ†Ø§Ù */
function addProduct(){
if(!productName.value||productPrice.value<=0||productQty.value<=0)return;
products.push({name:productName.value,price:+productPrice.value,qty:+productQty.value});
localStorage.setItem('products',JSON.stringify(products));
renderProducts();loadProducts();
productName.value=productPrice.value=productQty.value='';
}

function renderProducts(){
productList.innerHTML='';
products.forEach(p=>productList.innerHTML+=`<div>${p.name} | ${p.price} | ${p.qty}</div>`);
}

function loadProducts(){
saleProduct.innerHTML=purchaseProduct.innerHTML='';
products.forEach((p,i)=>{
saleProduct.innerHTML+=`<option value="${i}">${p.name}</option>`;
purchaseProduct.innerHTML+=`<option value="${i}">${p.name}</option>`;
});
}

/* Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª */
function addToInvoice(){
let p=products[saleProduct.value];
let q=+saleQty.value;
if(!p||q<=0||p.qty<q){alert("ÙƒÙ…ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©");return;}
invoice.push({name:p.name,qty:q,total:p.price*q});
renderInvoice();
}

function renderInvoice(){
let s=0;invoiceItems.innerHTML='';
invoice.forEach(i=>{s+=i.total;invoiceItems.innerHTML+=`<div>${i.name} Ã— ${i.qty}</div>`});
subTotal.innerText=s.toFixed(2);
let tax=settings.taxEnabled?s*(settings.taxRate/100):0;
taxRow.style.display=settings.taxEnabled?'block':'none';
taxAmount.innerText=tax.toFixed(2);
grandTotal.innerText=(s+tax).toFixed(2);
}

function saveInvoice(){
for(let i of invoice){
let p=products.find(x=>x.name===i.name);
if(!p||p.qty<i.qty){alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†");return;}
p.qty-=i.qty;
}
sales.push({id:Date.now(),total:+grandTotal.innerText,date:new Date().toISOString()});
localStorage.setItem('sales',JSON.stringify(sales));
localStorage.setItem('products',JSON.stringify(products));
invoice=[];renderInvoice();renderProducts();
subTotal.innerText=taxAmount.innerText=grandTotal.innerText="0";
alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© âœ…");
}

function printInvoice(){window.print();}

/* Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª */
let purchaseInvoice=[];
function addPurchase(){
if(purchasePrice.value<=0||purchaseQty.value<=0)return;
purchaseInvoice.push({
name:newProductName.value||products[purchaseProduct.value]?.name,
price:+purchasePrice.value,
qty:+purchaseQty.value
});
renderPurchase();
}

function renderPurchase(){
let t=0;purchaseItems.innerHTML='';
purchaseInvoice.forEach(i=>{t+=i.price*i.qty;purchaseItems.innerHTML+=`<div>${i.name}</div>`});
purchaseTotal.innerText=t.toFixed(2);
}

function savePurchase(){
purchaseInvoice.forEach(i=>{
let p=products.find(x=>x.name===i.name);
p?p.qty+=i.qty:products.push({name:i.name,price:i.price,qty:i.qty});
});
localStorage.setItem('products',JSON.stringify(products));
purchaseInvoice=[];renderPurchase();renderProducts();loadProducts();
alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª âœ…");
}

/* Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª */
function addExpense(){
if(expenseAmount.value<=0)return;
expenses.push({
type:expenseType.value,
desc:expenseDesc.value,
amount:+expenseAmount.value,
date:new Date().toISOString()
});
localStorage.setItem('expenses',JSON.stringify(expenses));
expenseDesc.value=expenseAmount.value='';
renderExpenses();
}

function renderExpenses(){
expenseList.innerHTML='';
expenses.forEach(e=>expenseList.innerHTML+=`<div>${e.type} - ${e.desc||''} : ${e.amount}</div>`);
}

/* Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± */
function isBetween(d,f,t){
d=new Date(d);
if(f&&d<new Date(f))return false;
if(t&&d>new Date(t))return false;
return true;
}

function showSalesReport(){
let total=0;reportResult.innerHTML='';
sales.forEach(s=>{
if(isBetween(s.date,fromDate.value,toDate.value)){
total+=s.total;
reportResult.innerHTML+=`<div>ÙØ§ØªÙˆØ±Ø© ${s.id} : ${s.total}</div>`;
}});
reportResult.innerHTML+=`<h3>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${total}</h3>`;
}

function showProfitReport(){
let s=0,e=0;
sales.forEach(x=>{if(isBetween(x.date,fromDate.value,toDate.value))s+=x.total});
expenses.forEach(x=>{if(isBetween(x.date,fromDate.value,toDate.value))e+=x.amount});
reportResult.innerHTML=`<h3>ØµØ§ÙÙŠ Ø§Ù„Ø¯Ø®Ù„: ${s-e}</h3><small>âš  Ù„Ø§ ÙŠØ´Ù…Ù„ ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©</small>`;
}

function showStockReport(){
reportResult.innerHTML='';
products.forEach(p=>reportResult.innerHTML+=`<div>${p.name} : ${p.qty}</div>`);
}

/* Excel */
function exportSalesExcel(){
let csv="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©,Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ\n";
sales.forEach(s=>{
if(isBetween(s.date,fromDate.value,toDate.value)){
csv+=`${s.id},${new Date(s.date).toLocaleDateString('ar-EG')},${s.total}\n`;
}});
let blob=new Blob([csv],{type:"text/csv"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="sales_report.csv";
a.click();
}

/* PDF */
function exportSalesPDF(){
let html="<h2>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h2><hr>";
sales.forEach(s=>{
if(isBetween(s.date,fromDate.value,toDate.value)){
html+=`<p>ÙØ§ØªÙˆØ±Ø© ${s.id}<br>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${s.total}</p><hr>`;
}});
let w=window.open("");
w.document.write(html);
w.print();
}

/* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
function saveSettings(){
settings={taxEnabled:taxEnabled.value==='true',taxRate:+taxRate.value};
localStorage.setItem('settings',JSON.stringify(settings));
alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª âœ…");
}

/* Backup */
function backupData(){
const data={products,sales,expenses,settings};
const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="backup_accounting.json";
a.click();
}

function restoreData(e){
const file=e.target.files[0];
if(!file)return;
const r=new FileReader();
r.onload=x=>{
const d=JSON.parse(x.target.result);
products=d.products||[];
sales=d.sales||[];
expenses=d.expenses||[];
settings=d.settings||settings;
localStorage.setItem("products",JSON.stringify(products));
localStorage.setItem("sales",JSON.stringify(sales));
localStorage.setItem("expenses",JSON.stringify(expenses));
localStorage.setItem("settings",JSON.stringify(settings));
renderProducts();renderExpenses();loadProducts();
alert("ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…");
};
r.readAsText(file);
}

renderProducts();renderExpenses();loadProducts();
</script>

<script>
if("serviceWorker" in navigator){
navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
